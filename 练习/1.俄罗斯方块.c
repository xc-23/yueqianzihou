#include <stdio.h>
#include <termios.h>
#include <unistd.h>
#include <fcntl.h>
#include <stdlib.h>
#include <time.h>

int kbhit(void)
{
	struct termios oldt, newt;
	int ch;
	int oldf;
	tcgetattr(STDIN_FILENO, &oldt);
	newt = oldt;
	newt.c_lflag &= ~(ICANON | ECHO);
	tcsetattr(STDIN_FILENO, TCSANOW, &newt);
	oldf = fcntl(STDIN_FILENO, F_GETFL, 0);
	fcntl(STDIN_FILENO, F_SETFL, oldf | O_NONBLOCK);
	ch = getchar();
	tcsetattr(STDIN_FILENO, TCSANOW, &oldt);
	fcntl(STDIN_FILENO, F_SETFL, oldf);
	if(ch != EOF)
	{
		ungetc(ch, stdin);
		return 1;
	}
	return 0;
} 


void main()
{
	int a,b,c,d,e,f;
 	int dfen=0;
	int s[20][30],ss[20][30],sum[20];
	int g,h,i,j,ch,www,aaa,ddd,sss,sl;
	char k,zt;

/**********************************定义初始化方框***************************************/
	for(a=0;a<20;a++)
		for(b=0;b<30;b++)
		{
			s[a][b]=0;
			ss[a][b]=0;
		}
    for(a=0;a<20;a++)
		for(b=0;b<30;b++)
			if(a==19||b==0||b==29)
		        ss[a][b]=1;
			else
				ss[a][b]=0;
/*****************************************************************************************/

/*************************************定义各种方块*****************************************/		
	int fk[7][4][4][4]=
	{
		{
			{0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0},
			{0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0},
			{0,0,0,00,0,0,0,1,1,1,1,,0,0,0,0},
			{0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0}
		},
		{
			{0,0,0,0,1,0,0,0,1,1,1,0,0,0,0,0},
			{0,1,1,0,0,1,0,0,0,1,0,0,0,0,0,0},
			{0,0,0,0,1,1,1,0,0,0,1,0,0,0,0,0},
			{0,0,1,0,0,0,1,0,0,1,1,0,0,0,0,0}
		},
		{
			{0,0,0,0,0,0,1,0,1,1,1,0,0,0,0,0},
            {0,1,0,0,0,1,0,0,0,1,1,0,0,0,0,0}, 
            {0,0,0,0,1,1,1,0,1,0,0,0,0,0,0,0},
			{0,1,1,0,0,0,1,0,0,0,1,0,0,0,0,0}
		},
		{
			{0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0},
			{0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0},
			{0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0},
			{0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0}
		},
		{
			{0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0},
			{1,0,0,0,1,1,0,0,0,1,0,0,0,0,0,0},
			{0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0},
			{1,0,0,0,1,1,0,0,0,1,0,0,0,0,0,0}
		},
		{
			{0,0,0,0,0,1,0,0,1,1,1,0,0,0,0,0},
			{0,1,0,0,0,1,1,0,0,1,0,0,0,0,0,0},
			{0,0,0,0,1,1,1,0,0,1,0,0,0,0,0,0},
			{0,1,0,0,1,1,0,0,0,1,0,0,0,0,0,0}
		},
		{
			{0,0,0,0,1,1,0,0,0,1,1,0,0,0,0,0},
			{0,1,0,0,1,1,0,0,1,0,0,0,0,0,0,0},
			{0,0,0,0,1,1,0,0,0,1,1,0,0,0,0,0},
			{0,1,0,0,1,1,0,0,1,0,0,0,0,0,0,0}
		}
	};
/*****************************************************************************************/

	
	for(;;)
	{	
		ch=12,k=48;
		srand((unsigned long)time(0)); 
		g=rand()%7;															//****
	    h=rand()%4;															//****
		for(i=0;i<20;i++)
		{
		
/*********************************判断是否死亡**********************************************/
begin:        for(a=0;a<3;a++)
                for(b=0;b<4;b++)
					if(ss[a][b+12]==1)
						{
							sleep(3);
							goto end;
						}
/*******************************************************************************/

/*********************************产生方块**********************************************/
		sl=100;
		    for(a=0;a<20;a++)
		        for(b=0;b<30;b++)
				{
					s[a][b]=0;
					sum[a]=0;
				}
            for(a=0;a<4;a++)
                for(b=0;b<4;b++)
	                s[a+i][b+ch]=fk[g][h][a][b];
/*************************************************************************************/
				
			
            
/*********************************显示输出函数*************************▦******/		
			for(a=0;a<20;a++)
			{
				if((a==5)&&(b==30))
					printf("       得分: %d",dfen);
		        printf("\n");
		        for(b=0;b<30;b++)
				{
					if(a==19||b==0||b==29)
						printf(" ▢");
					else
				        if(ss[a][b])
				            printf(" ■");
				        else
					        if(s[a][b]) 
						        printf(" ▢");
						    else
							    printf("  ");
				}
			}
/*************************************************************************************/

/***********************************得到键盘按键函数************************************/
			for(j=0;j<2;j++)
			{
                if(kbhit())												//*****
				{
    	            k=getchar();
                    break;
				}
			}
/***************************************************************************************/

/************************************根据按键执行不同指令*********************************/
			switch(k)
			{
			case 101://e退出游戏
				printf("\n游戏即将退出？\n请按回车键结束");
				k=48;
				getchar();
				goto end;
				break;

			case 119://w方块转向
				www=0;
				if(h+1==4)
					h=0;
				else 
					h=h+1;
				for(a=0;a<4;a++)
				 {
				 	for(b=0;b<4;b++)
				 	{
				 		www=fk[g][h][a][b]+ss[a+i][b+ch];
						if(www==2)
						{
							www=5;
							break;
						}
					}
					if(www==5)break;
				}
				if(www!=5)
					for(a=0;a<4;a++)
				 	{
					 	for(b=0;b<4;b++)
						{
							s[a+i][b+ch]=fk[g][h][a][b];
							if(a==3&&b==3)
							{
								system("clear");
								k=48;
								goto begin;
							}
						}
					}
				 else 
					 if(h==0)
						 h=3;
					 else
						 h=h-1;
				printf("\n%d",h);//
				k=48;break;

			case 97:aaa=2;//a方块左移
				for(a=0;a<4;a++)
                {
	                for(b=0;b<4;b++)
				        if(s[a+i][b+ch]+ss[a+i][b+ch-1]==2)
						{
							aaa=0;break;
						}
					if(aaa==0)
						break;
					aaa=1;
				}
					if(aaa==1)
					{
						ch=ch-1;
						system("clear");
						k=48;
						goto begin;
					}			
				k=48;
				break;

			case 100://d方块右移
				ddd=2;
				for(a=0;a<4;a++)
                {
	                for(b=0;b<4;b++)
				        if(s[a+i][b+ch]+ss[a+i][b+ch+1]==2)
						{
							ddd=0;
							break;
						}
					if(ddd==0)
						break;
					ddd=1;
				}
					if(ddd==1)
					{
						ch=ch+1;
						system("clear");
						k=48;
						goto begin;
					}			
					k=48;
					break;

			case 115://s方块下降
				k=48;
				sl=0;
				break;

			case 32:
				printf("\n游戏暂停");
				for(;;)
				{
					if(kbhit())
					{
						zt=getchar();
						if(zt==32)
						{
							break;
							zt=0;
						}
					}
				}
				k=48;
				break;			

			default :
				k=48;
				printf("\n没有输入");
			}
/**********************************************************************************************/

/******************************************方块到底固定*******************************************/
            for(a=0;a<4;a++)
                for(b=0;b<4;b++)
			        if(s[a+i][b+ch]+ss[a+1+i][b+ch]==2)
					{
						for(a=0;a<4;a++)
                			for(b=0;b<4;b++)
								if(ss[a+i][b+ch]!=1)	
					    			ss[a+i][b+ch]=s[a+i][b+ch];
					    			i=20;
					}
/***********************************************************************************************/

/********************************************得分消行********************************************/
				for(a=0;a<19;a++)
		            for(b=1;b<29;b++)
						sum[a]=sum[a]+ss[a][b];
					for(a=0;a<19;a++)
					 if(sum[a]==28)
					 {
						 for(b=1;b<29;b++)
							 ss[a][b]=0;
						 for(i=a;i>0;i--)
		                     for(j=1;j<29;j++)
							 {
								 ss[i][j]=ss[i-1][j];
							 }
						dfen=dfen+10;
					 }
/*************************************************************************************************/

	usleep(sl*4000);														
    system("clear");														
		}
	}
end:		
    system("clear");														
	printf("\n\n\n\n\n                     游戏结束");
	getchar();
}

